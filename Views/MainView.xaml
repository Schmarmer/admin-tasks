<Window x:Class="Admin_Tasks.Views.MainView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="clr-namespace:Admin_Tasks.Converters"
        xmlns:models="clr-namespace:Admin_Tasks.Models"
        mc:Ignorable="d"
        Title="Admin Tasks - Aufgabenverwaltung"
        Height="800" Width="1400"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        WindowState="Maximized">

    <Window.Resources>
        <converters:StatusToBrushConverter x:Key="StatusToBrushConverter" />
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:TaskAccentBrushConverter x:Key="TaskAccentBrushConverter" />
        <converters:TaskBackgroundBrushConverter x:Key="TaskBackgroundBrushConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
        <converters:PriorityDisplayConverter x:Key="PriorityDisplayConverter" />
        <converters:StatusDisplayConverter x:Key="StatusDisplayConverter" />
        <converters:FolderTaskCountConverter x:Key="FolderTaskCountConverter" />
        <converters:TaskUserPairConverter x:Key="TaskUserPairConverter" />
        
        <!-- Folder Icon Style -->
        <Style x:Key="FolderIconStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Width" Value="16" />
            <Setter Property="Height" Value="12" />
            <Setter Property="Margin" Value="0,0,8,0" />
        </Style>
        
        <!-- Sector Header Style -->
        <Style x:Key="SectorHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{DynamicResource TextBrush}" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>
        
        <!-- Folder Item Style -->
        <Style x:Key="FolderItemStyle" TargetType="Border">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="Margin" Value="0,0,0,4" />
            <Setter Property="Cursor" Value="Hand" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <!-- Task Item Enhanced Style -->
        <Style x:Key="TaskItemStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}" />
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="16,12" />
            <Setter Property="Margin" Value="0,0,0,8" />
            <Setter Property="SnapsToDevicePixels" Value="True" />
            <Setter Property="UseLayoutRounding" Value="True" />

            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}" />
                    <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Grid>
        <!-- Header Section -->
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource HeaderBackgroundBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" 
                Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="Admin Tasks" FontSize="24" FontWeight="Bold" 
                               Foreground="{DynamicResource TextBrush}" VerticalAlignment="Center" />
                    <TextBlock Text="Aufgabenverwaltung" FontSize="14" 
                               Foreground="{DynamicResource SecondaryTextBrush}" 
                               VerticalAlignment="Center" Margin="16,0,0,0" />
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <!-- Profil-Dropdown -->
                    <Grid>
                        <Button x:Name="ProfileButton" 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Padding="12,8" Margin="0,0,12,0"
                                Click="ProfileButton_Click">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="👤" FontSize="16" Margin="0,0,8,0" />
                                <TextBlock Text="{Binding CurrentUser.Username}" FontSize="14" />
                                <TextBlock Text="▼" FontSize="10" Margin="8,0,0,0" />
                            </StackPanel>
                        </Button>
                        
                        <!-- Dropdown-Popup -->
                        <Popup x:Name="ProfilePopup" 
                               PlacementTarget="{Binding ElementName=ProfileButton}"
                               Placement="Bottom"
                               AllowsTransparency="True"
                               StaysOpen="False">
                            <Border Background="{DynamicResource CardBackgroundBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="8"
                                    Padding="8"
                                    >
                                <Border.Effect>
                                    <DropShadowEffect Color="{DynamicResource ShadowColor}" 
                                                    BlurRadius="8" 
                                                    ShadowDepth="2" 
                                                    Opacity="0.3"/>
                                </Border.Effect>
                                <StackPanel MinWidth="200">
                                    <!-- Benutzer-Info -->
                                    <Border Background="{DynamicResource HeaderBackgroundBrush}"
                                            CornerRadius="4" Padding="12,8" Margin="0,0,0,8">
                                        <StackPanel>
                                            <TextBlock Text="{Binding CurrentUser.Username}" 
                                                       FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextBrush}" />
                                            <TextBlock Text="{Binding CurrentUser.Role}" 
                                                       FontSize="12"
                                                       Foreground="{DynamicResource SecondaryTextBrush}" />
                                        </StackPanel>
                                    </Border>
                                    
                                    <Separator Margin="0,4" />
                                    
                                    <!-- Menü-Optionen -->
                                    <Button Content="🎨 Theme wechseln" 
                                            Style="{StaticResource MenuButtonStyle}"
                                            Command="{Binding ToggleThemeCommand}"
                                            HorizontalAlignment="Stretch"
                                            Padding="12,8" Margin="0,2" />
                                    
                                    <Button Content="🔒 Auto-Login deaktivieren" 
                                            Style="{StaticResource MenuButtonStyle}"
                                            Command="{Binding DisableAutoLoginCommand}"
                                            HorizontalAlignment="Stretch"
                                            Padding="12,8" Margin="0,2" />
                                    
                                    <Button Content="👥 Benutzer verwalten" 
                                            Style="{StaticResource MenuButtonStyle}"
                                            Command="{Binding ManageUsersCommand}"
                                            HorizontalAlignment="Stretch"
                                            Padding="12,8" Margin="0,2" />
                                    
                                    <Separator Margin="0,4" />
                                    
                                    <Button Content="🚪 Abmelden" 
                                            Style="{StaticResource DangerButtonStyle}"
                                            Command="{Binding LogoutCommand}"
                                            HorizontalAlignment="Stretch"
                                            Padding="12,8" Margin="0,2" />
                                </StackPanel>
                            </Border>
                        </Popup>
                    </Grid>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Action Bar -->
        <Border Grid.Row="1" Background="{DynamicResource BackgroundBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" 
                Padding="24,12">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                <Button Content="📝 Task erstellen" Style="{StaticResource SuccessButtonStyle}" 
                        Command="{Binding CreateTaskCommand}" Margin="0,0,12,0" 
                        Padding="16,8" FontWeight="SemiBold" />
                <Button Content="✏️ Task bearbeiten" Style="{StaticResource ModernButtonStyle}" 
                        Command="{Binding EditTaskCommand}" Margin="0,0,12,0" 
                        Padding="16,8" IsEnabled="{Binding SelectedTask, Converter={StaticResource BooleanToVisibilityConverter}}" />
                <Button Content="🔄 Aktualisieren" Style="{StaticResource SecondaryButtonStyle}" 
                        Command="{Binding RefreshCommand}" Margin="0,0,12,0" 
                        Padding="16,8" />
                <Button Content="💬 Chat-Übersicht" Style="{StaticResource ModernButtonStyle}" 
                        Command="{Binding OpenChatOverviewCommand}" Margin="0,0,12,0" 
                        Padding="16,8" />
                <Button Content="📰 News" Style="{StaticResource ModernButtonStyle}" 
                        Command="{Binding OpenNewsCommand}" Margin="0,0,12,0" 
                        Padding="16,8" />
                <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="12,0" />
                <TextBlock Text="{Binding FilteredTasks.Count, StringFormat=\{0\} Aufgaben}" 
                           FontSize="12" Foreground="{DynamicResource SecondaryTextBrush}" 
                           VerticalAlignment="Center" />
            </StackPanel>
        </Border>

        <!-- Main Content Area - Two Sectors -->
        <Grid Grid.Row="2" Margin="24,16,24,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="200" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" MinWidth="400" />
            </Grid.ColumnDefinitions>

            <!-- Sektor 1: Ordnerauswahl -->
            <Border Grid.Column="0" Background="{DynamicResource CardBackgroundBrush}" 
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                    CornerRadius="8" Padding="16">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <!-- Standard-Ordner -->
                    <TextBlock Grid.Row="0" Text="📁 Standard-Ordner" Style="{StaticResource SectorHeaderStyle}" />
                    
                    <ListBox Grid.Row="1" ItemsSource="{Binding Folders}" 
                             SelectedItem="{Binding SelectedFolder}"
                             Background="Transparent" BorderThickness="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource FolderItemStyle}" Margin="0,2">
                                    <StackPanel Orientation="Horizontal">
                                        <Border Style="{StaticResource FolderIconStyle}" />
                                        <TextBlock Text="{Binding}" FontSize="14" 
                                                   Foreground="{DynamicResource TextBrush}" 
                                                   VerticalAlignment="Center" />
                                        <TextBlock FontSize="12" Margin="4,0,0,0"
                                                   Foreground="{DynamicResource SecondaryTextBrush}" 
                                                   VerticalAlignment="Center">
                                            <TextBlock.Text>
                                                <MultiBinding Converter="{StaticResource FolderTaskCountConverter}">
                                                    <!-- 0: folder name (string) -->
                                                    <Binding Path="." />
                                                    <!-- 1: view model reference (MainViewModel) -->
                                                    <Binding Path="DataContext" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <!-- Additional bindings only to trigger updates when counts change -->
                                                    <Binding Path="DataContext.AllTasksCount" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Path="DataContext.CreatedTasksCount" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Path="DataContext.AssignedTasksCount" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Path="DataContext.UnassignedTasksCount" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Path="DataContext.CompletedTasksCount" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    <Binding Path="DataContext.OpenTasksCount" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                </MultiBinding>
                                            </TextBlock.Text>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="BorderThickness" Value="0" />
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                    
                    <!-- Separator -->
                    <Border Grid.Row="2" Height="1" Background="{DynamicResource BorderBrush}" Margin="0,12" />
                    
                    <!-- Benutzerdefinierte Ordner -->
                    <Grid Grid.Row="3">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>
                        
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                            <TextBlock Text="🗂️ Meine Ordner" Style="{StaticResource SectorHeaderStyle}" />
                            <Button Content="+" Width="24" Height="24" Margin="8,0,0,0"
                                    Background="{DynamicResource AccentBrush}" 
                                    Foreground="White" BorderThickness="0"
                                    FontWeight="Bold" FontSize="12"
                                    ToolTip="Neuen Ordner erstellen"
                                    Click="CreateCustomFolder_Click" />
                        </StackPanel>
                        
                        <ListBox Grid.Row="1" ItemsSource="{Binding CustomFolders}" 
                                 SelectedItem="{Binding SelectedCustomFolder}"
                                 Background="Transparent" BorderThickness="0"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Style="{StaticResource FolderItemStyle}" Margin="0,2"
                                            AllowDrop="True"
                                            DragEnter="CustomFolderItem_DragEnter"
                                            DragOver="CustomFolderItem_DragOver"
                                            DragLeave="CustomFolderItem_DragLeave"
                                            Drop="CustomFolderItem_Drop"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            MinHeight="32">
                                        <Border.ContextMenu>
                                            <ContextMenu>
                                                <MenuItem Header="Ordner löschen" Click="DeleteCustomFolder_Click" 
                                                          CommandParameter="{Binding}" />
                                                <MenuItem Header="Ordner bearbeiten" Click="EditCustomFolder_Click" 
                                                          CommandParameter="{Binding}" />
                                            </ContextMenu>
                                        </Border.ContextMenu>
                                        <StackPanel Orientation="Horizontal" 
                                                    HorizontalAlignment="Stretch"
                                                    VerticalAlignment="Center"
                                                    Margin="8,6">
                                            <Border Width="12" Height="12" CornerRadius="2" Margin="0,0,8,0"
                                                    Background="{Binding Color, Converter={StaticResource ColorToBrushConverter}}" />
                                            <TextBlock Text="{Binding Name}" FontSize="14" 
                                                       Foreground="{DynamicResource TextBrush}" 
                                                       VerticalAlignment="Center" />
                                            <TextBlock Text="{Binding TaskIds.Count, StringFormat='({0})'}" 
                                                       FontSize="12" Margin="4,0,0,0"
                                                       Foreground="{DynamicResource SecondaryTextBrush}" 
                                                       VerticalAlignment="Center" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Background" Value="Transparent" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="Padding" Value="0" />
                                    <Setter Property="Margin" Value="0" />
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ListBoxItem">
                                                <ContentPresenter HorizontalAlignment="Stretch" 
                                                                  VerticalAlignment="Stretch" />
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.ItemContainerStyle>
                        </ListBox>
                    </Grid>
                </Grid>
            </Border>

            <!-- Splitter -->
            <GridSplitter Grid.Column="1" Width="8" Background="Transparent" 
                          HorizontalAlignment="Center" VerticalAlignment="Stretch" 
                          ShowsPreview="True" />

            <!-- Sektor 2: Aufgaben-Anzeige -->
            <Border Grid.Column="2" Background="{DynamicResource CardBackgroundBrush}" 
                    BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                    CornerRadius="8" Padding="16">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    
                    <TextBlock Grid.Row="0" Text="📋 Aufgaben" Style="{StaticResource SectorHeaderStyle}" />
                    
                    <!-- Filter und Suche -->
                    <Grid Grid.Row="1" Margin="0,0,0,12">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>
                        
                        <!-- Erste Zeile: Suchfeld und Status-Filter -->
                        <Grid Grid.Row="0" Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <TextBox Grid.Column="0" Style="{StaticResource ModernTextBoxStyle}" 
                                     Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                                     Tag="Aufgaben durchsuchen..." Margin="0,0,8,0" />
                            
                            <ComboBox Grid.Column="1" Width="120" Height="32" 
                                       ItemsSource="{Binding FilterStatuses}"
                                       SelectedItem="{Binding FilterStatus}" 
                                       DisplayMemberPath="DisplayName"
                                       Background="{DynamicResource BackgroundBrush}" 
                                       BorderBrush="{DynamicResource BorderBrush}" 
                                       Foreground="{DynamicResource TextBrush}" />
                        </Grid>
                        
                        <!-- Zweite Zeile: Erweiterte Filter -->
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- Prioritäts-Filter -->
                            <ComboBox Grid.Column="0" Height="32" Margin="0,0,4,0"
                                      ItemsSource="{Binding FilterPriorities}"
                                      SelectedItem="{Binding FilterPriority}"
                                      DisplayMemberPath="DisplayName"
                                      Background="{DynamicResource BackgroundBrush}" 
                                      BorderBrush="{DynamicResource BorderBrush}" 
                                      Foreground="{DynamicResource TextBrush}" />
                            
                            <!-- Zugewiesene Person Filter -->
                            <ComboBox Grid.Column="1" Height="32" Margin="4,0,4,0"
                                      ItemsSource="{Binding FilterUsers}"
                                      SelectedItem="{Binding FilterAssignedUser}"
                                      DisplayMemberPath="FullName"
                                      Background="{DynamicResource BackgroundBrush}" 
                                      BorderBrush="{DynamicResource BorderBrush}" 
                                      Foreground="{DynamicResource TextBrush}" />
                            
                            <!-- Bald ablaufend Toggle Button -->
                            <ToggleButton Grid.Column="2" Content="Bald ablaufend" 
                                          IsChecked="{Binding FilterDueSoon}"
                                          VerticalAlignment="Center" Margin="4,0,4,0"
                                          Height="32" Padding="8,4">
                                <ToggleButton.Style>
                                    <Style TargetType="ToggleButton">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                        <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
                                        <Setter Property="BorderThickness" Value="1"/>
                                        <Setter Property="Cursor" Value="Hand"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ToggleButton">
                                                    <Border x:Name="MainBorder"
                                                            Background="{TemplateBinding Background}"
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="{TemplateBinding BorderThickness}"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter x:Name="ContentPresenter"
                                                                          HorizontalAlignment="Center" 
                                                                          VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <!-- Normal state -->
                                                        <Trigger Property="IsChecked" Value="False">
                                                            <Setter TargetName="MainBorder" Property="Background" Value="Transparent"/>
                                                            <Setter Property="Foreground" Value="{DynamicResource TextBrush}"/>
                                                        </Trigger>
                                                        <!-- Checked state -->
                                                        <Trigger Property="IsChecked" Value="True">
                                                            <Setter TargetName="MainBorder" Property="Background" Value="#4A9EFF"/>
                                                            <Setter Property="Foreground" Value="White"/>
                                                            <Setter TargetName="MainBorder" Property="BorderBrush" Value="#4A9EFF"/>
                                                        </Trigger>
                                                        <!-- Hover effect -->
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="MainBorder" Property="BorderBrush" Value="#4A9EFF"/>
                                                        </Trigger>
                                                        <!-- Checked + Hover -->
                                                        <MultiTrigger>
                                                            <MultiTrigger.Conditions>
                                                                <Condition Property="IsChecked" Value="True"/>
                                                                <Condition Property="IsMouseOver" Value="True"/>
                                                            </MultiTrigger.Conditions>
                                                            <Setter TargetName="MainBorder" Property="Background" Value="#6BB6FF"/>
                                                        </MultiTrigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ToggleButton.Style>
                            </ToggleButton>
                            
                            <!-- Sortierung Label -->
                            <TextBlock Grid.Column="3" Text="Sortierung:" 
                                       VerticalAlignment="Center" Margin="8,0,4,0"
                                       Foreground="{DynamicResource TextBrush}" />
                            
                            <!-- Sortierungs-ComboBox -->
                            <ComboBox Grid.Column="4" Height="32" Margin="4,0,0,0"
                                      ItemsSource="{Binding SortOptions}"
                                      SelectedItem="{Binding SelectedSortOption}"
                                      Background="{DynamicResource BackgroundBrush}" 
                                      BorderBrush="{DynamicResource BorderBrush}" 
                                      Foreground="{DynamicResource TextBrush}" />
                            
                            <!-- Filter zurücksetzen Button -->
                            <Button Grid.Column="5" Content="🔄 Filter zurücksetzen" 
                                    Command="{Binding ClearSearchCommand}"
                                    Height="32" Margin="8,0,0,0" Padding="8,4"
                                    Background="{DynamicResource BackgroundBrush}" 
                                    BorderBrush="{DynamicResource BorderBrush}" 
                                    Foreground="{DynamicResource TextBrush}"
                                    Cursor="Hand">
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="Button">
                                                    <Border x:Name="MainBorder"
                                                            Background="{TemplateBinding Background}"
                                                            BorderBrush="{TemplateBinding BorderBrush}"
                                                            BorderThickness="1"
                                                            CornerRadius="4"
                                                            Padding="{TemplateBinding Padding}">
                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                          VerticalAlignment="Center"/>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="MainBorder" Property="BorderBrush" Value="#4A9EFF"/>
                                                            <Setter TargetName="MainBorder" Property="Background" Value="#F0F8FF"/>
                                                        </Trigger>
                                                        <Trigger Property="IsPressed" Value="True">
                                                            <Setter TargetName="MainBorder" Property="Background" Value="#E6F3FF"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </Grid>
                    
                    <!-- Aufgaben-Liste -->
                    <ListView Grid.Row="2" ItemsSource="{Binding FilteredTasks}" 
                              SelectedItem="{Binding SelectedTask}" 
                              Background="Transparent" BorderThickness="0" 
                              ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                              MouseDoubleClick="TaskList_MouseDoubleClick"
                              PreviewMouseLeftButtonDown="TaskList_PreviewMouseLeftButtonDown"
                              MouseMove="TaskList_MouseMove">
                        <ListView.ItemContainerStyle>
                            <Style TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                <Setter Property="Padding" Value="0" />
                                <Setter Property="Margin" Value="0,2" />
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="BorderThickness" Value="0" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListViewItem">
                                            <Border Background="{TemplateBinding Background}" 
                                                    BorderBrush="{TemplateBinding BorderBrush}" 
                                                    BorderThickness="{TemplateBinding BorderThickness}" 
                                                    Padding="{TemplateBinding Padding}" 
                                                    Margin="{TemplateBinding Margin}">
                                                <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                                  VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource SelectionBackgroundBrush}" />
                                    </Trigger>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ListView.ItemContainerStyle>
                        
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource TaskItemStyle}" Tag="{Binding DataContext, RelativeSource={RelativeSource AncestorType=Window}}">
                                     <Border.ContextMenu>
                                         <ContextMenu>
                                             <!-- Only show for unassigned tasks -->
                                             <ContextMenu.Visibility>
                                                 <Binding Path="PlacementTarget.DataContext.AssignedToUserId"
                                                                   RelativeSource="{RelativeSource AncestorType=ContextMenu}"
                                                                   Converter="{StaticResource NullToVisibilityConverter}" />
                                             </ContextMenu.Visibility>

                                             <!-- Self-assign -->
                                             <MenuItem Header="Übernehmen"
                                                                Command="{Binding PlacementTarget.Tag.SelfAssignTaskCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />

                                             <!-- Assign to specific user dialog -->
                                             <MenuItem Header="Übergeben an..."
                                                                Command="{Binding PlacementTarget.Tag.ShowAssignTaskDialogCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                                                CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}" />
                                                  </ContextMenu>
                                              </Border.ContextMenu>
                                    <!-- Overlay für besitzlose Tasks -->
                                    <Border.Background>
                                        <Binding Path="." Converter="{StaticResource TaskBackgroundBrushConverter}" />
                                    </Border.Background>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        
                                        <!-- Akzentlinie am linken Rand -->
                                        <Border Width="4" HorizontalAlignment="Left" VerticalAlignment="Stretch" 
                                                CornerRadius="2,0,0,2" Margin="-16,-12,-12,-12">
                                            <Border.Background>
                                                <Binding Path="." Converter="{StaticResource TaskAccentBrushConverter}" />
                                            </Border.Background>
                                        </Border>
                                        
                                        <!-- Header mit Titel und Status -->
                                        <Grid Grid.Row="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <TextBlock Grid.Column="0" Text="{Binding Title}" 
                                                       FontSize="16" FontWeight="SemiBold" 
                                                       Foreground="{DynamicResource TextBrush}" 
                                                       TextWrapping="Wrap" />
                                            
                                            <!-- Ohne Besitzer Badge -->
                                            <Border Grid.Column="1" Background="{Binding ., Converter={StaticResource TaskAccentBrushConverter}}" 
                                                    CornerRadius="12" Padding="6,3" Margin="8,0,4,0"
                                                    Visibility="{Binding AssignedToUserId, Converter={StaticResource NullToVisibilityConverter}}">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="⚠️" FontSize="10" Margin="0,0,2,0" />
                                                    <TextBlock Text="Ohne Besitzer" FontSize="10" 
                                                               FontWeight="SemiBold" Foreground="White" />
                                                </StackPanel>
                                            </Border>
                                            
                                            <Border Grid.Column="2" Background="{Binding Status, Converter={StaticResource StatusToBrushConverter}}" 
                                                    CornerRadius="12" Padding="8,4" Margin="4,0,0,0">
                                                <TextBlock Text="{Binding Status}" FontSize="11" 
                                                           FontWeight="SemiBold" Foreground="White" />
                                            </Border>
                                        </Grid>
                                        
                                        <!-- Custom Folder Indicators -->
                                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,4,0,0">
                                            <StackPanel.Visibility>
                                                <MultiBinding Converter="{StaticResource TaskFolderVisibilityConverter}">
                                                    <Binding Path="." />
                                                        <Binding Path="DataContext.CustomFolders" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    </MultiBinding>
                                                </StackPanel.Visibility>
                                            
                                            <Border Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="6,2" Margin="0,0,4,0">
                                                <StackPanel Orientation="Horizontal">
                                                    <TextBlock Text="📁" FontSize="10" Margin="0,0,2,0" />
                                                    <TextBlock FontSize="9" FontWeight="Medium" Foreground="White">
                                                        <TextBlock.Text>
                                                            <MultiBinding Converter="{StaticResource TaskFolderNamesConverter}">
                                                                <Binding Path="." />
                                                                <Binding Path="DataContext.CustomFolders" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                            </MultiBinding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>
                                        
                                        <!-- Beschreibung -->
                                        <TextBlock Grid.Row="2" Text="{Binding Description}" 
                                                   FontSize="13" Foreground="{DynamicResource SecondaryTextBrush}" 
                                                   TextWrapping="Wrap" Margin="0,8,0,0" 
                                                   MaxHeight="60" TextTrimming="CharacterEllipsis" />
                                        
                                        <!-- Footer mit Priorität, Accept-Button und Datum -->
                                        <Grid Grid.Row="3" Margin="0,12,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>
                                            
                                            <Border Grid.Column="0" Background="{Binding Priority, Converter={StaticResource StatusToBrushConverter}}" 
                                                    CornerRadius="4" Padding="6,2">
                                                <TextBlock Text="{Binding Priority}" FontSize="10" 
                                                           FontWeight="SemiBold" Foreground="White" />
                                            </Border>
                                            
                                            <!-- Accept Button -->
                                            <Button Grid.Column="2" Content="✓ Annehmen" 
                                                    FontSize="10" FontWeight="SemiBold"
                                                    Background="{DynamicResource AccentBrush}" 
                                                    Foreground="White" 
                                                    BorderThickness="0" 
                                                    Padding="8,4" 
                                                    Margin="0,0,8,0"
                                                    Command="{Binding DataContext.AcceptTaskCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}">
                                                <Button.Visibility>
                                                    <MultiBinding Converter="{StaticResource TaskAcceptVisibilityConverter}">
                                                        <Binding Path="." />
                                                        <Binding Path="DataContext.CurrentUser" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    </MultiBinding>
                                                </Button.Visibility>
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Cursor" Value="Hand" />
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}" 
                                                                            CornerRadius="4" 
                                                                            Padding="{TemplateBinding Padding}">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center" />
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource AccentHoverBrush}" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            
                                            <!-- Forward Button -->
                                            <Button Grid.Column="3" Content="↗ Weiterleiten" 
                                                    FontSize="10" FontWeight="SemiBold"
                                                    Background="{DynamicResource WarningBrush}" 
                                                    Foreground="White" 
                                                    BorderThickness="0" 
                                                    Padding="8,4" 
                                                    Margin="0,0,8,0"
                                                    Click="ForwardButton_Click"
                                                    Tag="{Binding}">
                                                <Button.Visibility>
                                                    <MultiBinding Converter="{StaticResource TaskForwardVisibilityConverter}">
                                                        <Binding Path="." />
                                                        <Binding Path="DataContext.CurrentUser" RelativeSource="{RelativeSource AncestorType=Window}" />
                                                    </MultiBinding>
                                                </Button.Visibility>
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Cursor" Value="Hand" />
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}" 
                                                                            CornerRadius="4" 
                                                                            Padding="{TemplateBinding Padding}">
                                                                        <ContentPresenter HorizontalAlignment="Center" 
                                                                                          VerticalAlignment="Center" />
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource WarningHoverBrush}" />
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            
                                            <TextBlock Grid.Column="4" Text="{Binding CreatedAt, StringFormat=dd.MM.yyyy}" 
                                                       FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}" 
                                                       VerticalAlignment="Center" />
                                        </Grid>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </Border>


        </Grid>
        
        <!-- Loading Overlay -->
        <Border Grid.RowSpan="3" Background="Black" Opacity="0.5" 
                Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="100" Height="6" 
                             Foreground="{DynamicResource AccentBrush}" 
                             Background="{DynamicResource BorderBrush}" />
                <TextBlock Text="Lade Aufgaben..." FontSize="14" 
                           Foreground="White" HorizontalAlignment="Center" 
                           Margin="0,16,0,0" />
            </StackPanel>
        </Border>
    </Grid>
</Window>