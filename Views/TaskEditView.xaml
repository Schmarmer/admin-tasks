<Window x:Class="Admin_Tasks.Views.TaskEditView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:Admin_Tasks.Converters"
        xmlns:local="clr-namespace:Admin_Tasks.Converters"
        Title="{Binding Title}" 
        Height="700" Width="600"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource PrimaryBackgroundBrush}"
        ResizeMode="CanResize"
        MinHeight="600" MinWidth="500">
    
    <Window.Resources>
        <converters:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:NotNullToVisibilityConverter x:Key="NotNullToVisibilityConverter"/>
        <converters:PriorityDisplayConverter x:Key="PriorityDisplayConverter"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header mit Gradient -->
        <Border Grid.Row="0" 
                Background="{DynamicResource AccentBrush}"
                Padding="30,20">
            <StackPanel>
                <TextBlock Text="{Binding Title}"
                           FontSize="28" 
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="Füllen Sie alle erforderlichen Felder aus"
                           FontSize="14" 
                           Foreground="White"
                           Opacity="0.8"
                           HorizontalAlignment="Center"
                           Margin="0,5,0,0"/>
            </StackPanel>
        </Border>
        
        <!-- Form Content -->
        <ScrollViewer Grid.Row="1" 
                      VerticalScrollBarVisibility="Auto"
                      Padding="30,20">
            <StackPanel Margin="0,10">
                
                <!-- Titel -->
                <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <Path Data="M9,22A1,1 0 0,1 8,21V18H4A2,2 0 0,1 2,16V4C2,2.89 2.9,2 4,2H20A2,2 0 0,1 22,4V16A2,2 0 0,1 20,18H13.9L10.2,21.71C10,21.9 9.75,22 9.5,22V22H9Z" 
                                  Fill="{DynamicResource AccentBrush}" 
                                  Width="20" Height="20" 
                                  Stretch="Uniform" 
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="Aufgaben-Titel" 
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       Margin="10,0,0,0"/>
                            <TextBlock Text="*" 
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{DynamicResource DangerBrush}"
                                       Margin="5,0,0,0"/>
                        </StackPanel>
                        <TextBox Text="{Binding TaskTitle, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 FontSize="14"
                                 Padding="12,10"/>
                    </StackPanel>
                </Border>
                
                <!-- Beschreibung -->
                <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" 
                                  Fill="{DynamicResource AccentBrush}" 
                                  Width="20" Height="20" 
                                  Stretch="Uniform" 
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="Detaillierte Beschreibung" 
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       Margin="10,0,0,0"/>
                        </StackPanel>
                        <TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 Height="120"
                                 FontSize="14"
                                 Padding="12,10"
                                 TextWrapping="Wrap"
                                 AcceptsReturn="True"
                                 VerticalScrollBarVisibility="Auto"/>
                    </StackPanel>
                </Border>
                
                <!-- Priorität und Zuweisungen in einer Zeile -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Priorität -->
                    <Border Grid.Column="0"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="10"
                            Padding="20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Path Data="M12,2L13.09,8.26L22,9L17,14L18.18,22L12,19.77L5.82,22L7,14L2,9L10.91,8.26L12,2Z" 
                                      Fill="{DynamicResource AccentBrush}" 
                                      Width="18" Height="18" 
                                      Stretch="Uniform" 
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Priorität" 
                                           FontWeight="Bold"
                                           FontSize="14"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           Margin="8,0,0,0"/>
                            </StackPanel>
                            <ComboBox SelectedItem="{Binding Priority}"
                                      ItemsSource="{Binding TaskPriorities}"
                                      Background="{DynamicResource SecondaryBackgroundBrush}"
                                      Foreground="{DynamicResource PrimaryTextBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      Padding="12,8"
                                      FontSize="14">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource PriorityDisplayConverter}}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                    </Border>
                    
                    <!-- Zugewiesen an -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="10"
                            Padding="20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Path Data="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" 
                                      Fill="{DynamicResource AccentBrush}" 
                                      Width="18" Height="18" 
                                      Stretch="Uniform" 
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Zugewiesen an" 
                                           FontWeight="Bold"
                                           FontSize="14"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           Margin="8,0,0,0"/>
                            </StackPanel>
                            <ComboBox ItemsSource="{Binding AvailableUsersWithNone, FallbackValue={x:Null}}"
                                      SelectedItem="{Binding AssignedUser, TargetNullValue={x:Null}}"
                                      Background="{DynamicResource SecondaryBackgroundBrush}"
                                      Foreground="{DynamicResource PrimaryTextBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      Padding="12,8"
                                      FontSize="14">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="{Binding Username, FallbackValue='Ohne Besitzer'}" FontWeight="SemiBold"/>
                                            <TextBlock Text=" - " Margin="5,0" Visibility="{Binding Role, Converter={StaticResource NotNullToVisibilityConverter}}"/>
                                            <TextBlock Text="{Binding Role, FallbackValue=''}" 
                                                       Foreground="{DynamicResource SecondaryTextBrush}"
                                                       Visibility="{Binding Role, Converter={StaticResource NotNullToVisibilityConverter}}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                        </StackPanel>
                    </Border>
                </Grid>
                
                <!-- Kategorie -->
                <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                            <Path Data="M12,2L13.09,8.26L22,9L17,14L18.18,22L12,19.77L5.82,22L7,14L2,9L10.91,8.26L12,2Z" 
                                  Fill="{DynamicResource AccentBrush}" 
                                  Width="18" Height="18" 
                                  Stretch="Uniform" 
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="Kategorie" 
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       Margin="10,0,0,0"/>
                        </StackPanel>
                        
                        <!-- Kategorie-Auswahl -->
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Bestehende Kategorie auswählen -->
                            <ComboBox Grid.Row="0"
                                      ItemsSource="{Binding AvailableCategories}"
                                      SelectedItem="{Binding SelectedCategory}"
                                      Background="{DynamicResource SecondaryBackgroundBrush}"
                                      Foreground="{DynamicResource PrimaryTextBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      Padding="12,8"
                                      FontSize="14"
                                      Margin="0,0,0,10"
                                      Visibility="{Binding IsCreatingNewCategory, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <Border Width="12" Height="12" 
                                                    Background="{Binding Color, Converter={StaticResource ColorToBrushConverter}, FallbackValue=#007ACC, TargetNullValue=#007ACC}" 
                                                    CornerRadius="2" 
                                                    Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>
                            
                            <!-- Neue Kategorie erstellen -->
                            <StackPanel Grid.Row="1" 
                                        Orientation="Horizontal" 
                                        Visibility="{Binding IsCreatingNewCategory, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <TextBox Text="{Binding NewCategoryName, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{StaticResource ModernTextBoxStyle}"
                                          FontSize="14"
                                          Padding="12,8"
                                          Width="200"
                                          Margin="0,0,10,0"
                                          Tag="Kategorie-Name eingeben..."/>
                                <Button Content="✓ Erstellen"
                                        Command="{Binding CreateCategoryCommand}"
                                        Style="{StaticResource ModernButtonStyle}"
                                        Background="{DynamicResource SuccessBrush}"
                                        Foreground="White"
                                        Padding="15,8"
                                        Margin="0,0,10,0"/>
                                <Button Content="✕ Abbrechen"
                                        Click="CancelNewCategory_Click"
                                        Style="{StaticResource ModernButtonStyle}"
                                        Background="{DynamicResource DangerBrush}"
                                        Foreground="White"
                                        Padding="15,8"/>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Button für neue Kategorie -->
                        <Button Content="+ Neue Kategorie erstellen"
                                Click="CreateNewCategory_Click"
                                Style="{StaticResource ModernButtonStyle}"
                                Background="{DynamicResource AccentBrush}"
                                Foreground="White"
                                Padding="12,8"
                                HorizontalAlignment="Left"
                                Margin="0,10,0,0"
                                Visibility="{Binding IsCreatingNewCategory, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </Border>
                
                <!-- Status und Fälligkeitsdatum in einer Zeile -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Status (nur bei Bearbeitung) -->
                    <Border Grid.Column="0"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="10"
                            Padding="20"
                            Visibility="{Binding IsEditMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Path Data="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.91,10.59L6.5,12L11,16.5Z" 
                                      Fill="{DynamicResource AccentBrush}" 
                                      Width="18" Height="18" 
                                      Stretch="Uniform" 
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Status" 
                                           FontWeight="Bold"
                                           FontSize="14"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           Margin="8,0,0,0"/>
                            </StackPanel>
                            <ComboBox SelectedItem="{Binding Status}"
                                      Background="{DynamicResource SecondaryBackgroundBrush}"
                                      Foreground="{DynamicResource PrimaryTextBrush}"
                                      BorderBrush="{DynamicResource BorderBrush}"
                                      Padding="12,8"
                                      FontSize="14">
                                <ComboBoxItem Content="Offen"/>
                                <ComboBoxItem Content="In Bearbeitung"/>
                                <ComboBoxItem Content="Abgeschlossen"/>
                            </ComboBox>
                        </StackPanel>
                    </Border>
                    
                    <!-- Fälligkeitsdatum -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource SecondaryBackgroundBrush}"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="10"
                            Padding="20">
                        <StackPanel>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Path Data="M19,3H18V1H16V3H8V1H6V3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z" 
                                      Fill="{DynamicResource AccentBrush}" 
                                      Width="18" Height="18" 
                                      Stretch="Uniform" 
                                      VerticalAlignment="Center"/>
                                <TextBlock Text="Fälligkeitsdatum" 
                                           FontWeight="Bold"
                                           FontSize="14"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           Margin="8,0,0,0"/>
                            </StackPanel>
                            <DatePicker SelectedDate="{Binding DueDate}"
                                        Background="{DynamicResource SecondaryBackgroundBrush}"
                                        Foreground="{DynamicResource PrimaryTextBrush}"
                                        BorderBrush="{DynamicResource BorderBrush}"
                                        Padding="12,8"
                                        FontSize="14"/>
                        </StackPanel>
                    </Border>
                </Grid>
                
                <!-- Bildanhänge -->
                <Border Background="{DynamicResource SecondaryBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="1"
                        CornerRadius="10"
                        Padding="20"
                        Margin="0,0,0,20">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                            <Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,11L16,15H13V19H11V15H8L12,11Z" 
                                  Fill="{DynamicResource AccentBrush}" 
                                  Width="20" Height="20" 
                                  Stretch="Uniform" 
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="Bildanhänge" 
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                       Margin="10,0,0,0"/>
                        </StackPanel>
                        
                        <!-- Upload-Bereich -->
                        <Border Background="{DynamicResource PrimaryBackgroundBrush}"
                                BorderBrush="{DynamicResource AccentBrush}"
                                BorderThickness="2"
                                CornerRadius="8"
                                Padding="15"
                                Margin="0,0,0,15"
                                MinHeight="200">
                            <ContentPresenter x:Name="ImageUploadPresenter" 
                                              HorizontalAlignment="Stretch"
                                              VerticalAlignment="Stretch" />
                        </Border>
                        
                        <!-- Anzeige hochgeladener Anhänge -->
                        <Border Background="{DynamicResource PrimaryBackgroundBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="15">
                            <StackPanel>
                                <TextBlock FontWeight="SemiBold"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           Margin="0,0,0,10">
                                    <TextBlock.Text>
                                        <Binding Path="IsEditMode">
                                            <Binding.Converter>
                                                <local:BooleanToStringConverter TrueValue="Vorhandene Anhänge" FalseValue="Hochgeladene Bilder" />
                                            </Binding.Converter>
                                        </Binding>
                                    </TextBlock.Text>
                                </TextBlock>
                                <ContentPresenter x:Name="AttachmentDisplayPresenter" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>
                
                <!-- Fehlerbereich -->
                <Border Background="{DynamicResource DangerBrush}"
                        CornerRadius="5"
                        Padding="15,10"
                        Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="{Binding ErrorMessage}"
                               Foreground="White"
                               FontWeight="SemiBold"
                               TextWrapping="Wrap"/>
                </Border>
                
            </StackPanel>
        </ScrollViewer>
        
        <!-- Buttons -->
        <Border Grid.Row="2" 
                Background="{DynamicResource SecondaryBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="30,20">
            <StackPanel Orientation="Horizontal" 
                        HorizontalAlignment="Right">
                <Button Content="✕ Abbrechen"
                        Command="{Binding CancelCommand}"
                        Style="{StaticResource ModernButtonStyle}"
                        Background="Transparent"
                        Foreground="{DynamicResource PrimaryTextBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="2"
                        Margin="0,0,15,0"
                        Padding="25,12"
                        MinWidth="120"
                        FontSize="14"
                        FontWeight="SemiBold"/>
                
                <Button Command="{Binding SaveCommand}"
                        Style="{StaticResource ModernButtonStyle}"
                        Background="{DynamicResource AccentBrush}"
                        Foreground="White"
                        BorderThickness="0"
                        Padding="25,12"
                        MinWidth="120"
                        FontSize="14"
                        FontWeight="SemiBold"
                        IsEnabled="{Binding CanSave}">
                    <Button.Content>
                        <StackPanel Orientation="Horizontal">
                            <Path Data="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z" 
                                  Fill="White" 
                                  Width="16" Height="16" 
                                  Stretch="Uniform" 
                                  VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding SaveButtonText}" 
                                       Margin="8,0,0,0" 
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                    </Button.Content>
                </Button>
            </StackPanel>
        </Border>
        
        <!-- Loading Overlay -->
        <Border Grid.RowSpan="3"
                Background="Black" Opacity="0.5"
                Visibility="{Binding IsBusy, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" 
                        VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" 
                             Width="100" 
                             Height="20"
                             Margin="0,0,0,10"/>
                <TextBlock Text="Wird gespeichert..."
                           Foreground="White"
                           FontSize="14"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>
        
    </Grid>
</Window>