<UserControl x:Class="Admin_Tasks.Views.ChatOverviewView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Admin_Tasks.Views"
             xmlns:vm="clr-namespace:Admin_Tasks.ViewModels"
             xmlns:views="clr-namespace:Admin_Tasks.Views"
             xmlns:converters="clr-namespace:Admin_Tasks.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200"
             d:DataContext="{d:DesignInstance Type=vm:ChatOverviewViewModel}">
    
    <UserControl.Resources>
        <!-- Chat List Item Template -->
        <DataTemplate x:Key="ChatListItemTemplate">
            <Border Background="{DynamicResource BackgroundBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="12,8"
                    Cursor="Hand">
                <Border.InputBindings>
                    <MouseBinding MouseAction="LeftClick" 
                                  Command="{Binding DataContext.SelectChatCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  CommandParameter="{Binding}" />
                </Border.InputBindings>
                
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Task-Details anzeigen" 
                                  Command="{Binding DataContext.ShowTaskDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                  CommandParameter="{Binding}">
                            <MenuItem.Icon>
                                <Path Data="M14,3V5H17.59L7.76,14.83L9.17,16.24L19,6.41V10H21V3M19,19H5V5H12V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V12H19V19Z" 
                                      Fill="{DynamicResource ForegroundBrush}" 
                                      Width="12" Height="12" 
                                      Stretch="Uniform" />
                            </MenuItem.Icon>
                        </MenuItem>
                    </ContextMenu>
                </Border.ContextMenu>
                
                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource HoverBrush}" />
                            </Trigger>
                            <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                <Setter Property="Background" Value="{DynamicResource AccentBrush}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="40" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    
                    <!-- Task Icon/Avatar -->
                    <Border Grid.Column="0" 
                            Width="36" Height="36"
                            Background="{DynamicResource AccentBrush}"
                            CornerRadius="18"
                            VerticalAlignment="Top"
                            Margin="0,4,0,0"
                            Effect="{DynamicResource AvatarShadowEffect}"
                            Cursor="Hand">
                        <Border.InputBindings>
                            <MouseBinding MouseAction="LeftDoubleClick" 
                                          Command="{Binding DataContext.ShowTaskDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                          CommandParameter="{Binding}" />
                        </Border.InputBindings>
                        <TextBlock Text="{Binding TaskTitle, Converter={StaticResource FirstLetterConverter}}"
                                   Foreground="White"
                                   FontWeight="SemiBold"
                                   FontSize="15"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center" />
                    </Border>
                    
                    <!-- Chat Info -->
                    <StackPanel Grid.Column="1" Margin="12,0,8,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <!-- Task Title -->
                            <TextBlock Grid.Column="0"
                                       Text="{Binding TaskTitle}"
                                       FontWeight="SemiBold"
                                       FontSize="15"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       TextTrimming="CharacterEllipsis" />
                            
                            <!-- Favorite/Mute Icons -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="8,0,0,0">
                                <Button Width="16" Height="16" 
                                        Background="Transparent" 
                                        BorderThickness="0"
                                        Padding="0"
                                        Command="{Binding DataContext.ToggleFavoriteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Visibility="{Binding IsFavorite, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Path Data="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"
                                          Fill="Gold" Width="12" Height="12" Stretch="Uniform" />
                                </Button>
                                
                                <Button Width="16" Height="16" 
                                        Background="Transparent" 
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="4,0,0,0"
                                        Command="{Binding DataContext.ToggleMuteCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}"
                                        Visibility="{Binding IsMuted, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Path Data="M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73L4.27,3Z"
                                          Fill="{DynamicResource MutedBrush}" Width="12" Height="12" Stretch="Uniform" />
                                </Button>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Last Message Preview -->
                        <TextBlock Text="{Binding LastMessageContent}"
                                   FontSize="13"
                                   Foreground="{DynamicResource SecondaryForegroundBrush}"
                                   TextTrimming="CharacterEllipsis"
                                   TextWrapping="Wrap"
                                   MaxHeight="32"
                                   Margin="0,4,0,0" />
                        
                        <!-- Last Message Author and Time -->
                        <Grid Margin="0,2,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0"
                                       Text="{Binding LastMessageAuthor.Username}"
                                       FontSize="11"
                                       Foreground="{DynamicResource TertiaryForegroundBrush}"
                                       TextTrimming="CharacterEllipsis" />
                            
                            <TextBlock Grid.Column="1"
                                       Text="{Binding LastMessageTime, Converter={StaticResource RelativeTimeConverter}}"
                                       FontSize="11"
                                       Foreground="{DynamicResource TertiaryForegroundBrush}" />
                        </Grid>
                    </StackPanel>
                    
                    <!-- Unread Count Badge -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource AccentBrush}"
                            CornerRadius="12"
                            MinWidth="24" Height="24"
                            VerticalAlignment="Top"
                            Margin="0,8,0,0"
                            Effect="{DynamicResource BadgeShadowEffect}"
                            Visibility="{Binding UnreadCount, Converter={StaticResource CountToVisibilityConverter}}">
                        <TextBlock Text="{Binding UnreadCount}"
                                   Foreground="White"
                                   FontSize="12"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Margin="8,4" />
                    </Border>
                </Grid>
            </Border>
        </DataTemplate>
        
        <!-- Loading Template -->
        <DataTemplate x:Key="LoadingTemplate">
            <Grid Height="60">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressBar Width="20" Height="20" IsIndeterminate="True" Margin="0,0,8,0" />
                    <TextBlock Text="Lade Chats..." 
                               Foreground="{DynamicResource SecondaryForegroundBrush}"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Grid>
        </DataTemplate>
        
        <!-- Empty State Template -->
        <DataTemplate x:Key="EmptyStateTemplate">
            <Grid Height="200">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Path Data="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4C22,2.89 21.1,2 20,2Z"
                          Fill="{DynamicResource TertiaryForegroundBrush}"
                          Width="48" Height="48"
                          Stretch="Uniform"
                          Margin="0,0,0,16" />
                    <TextBlock Text="Keine aktiven Chats"
                               FontSize="16"
                               FontWeight="SemiBold"
                               Foreground="{DynamicResource SecondaryForegroundBrush}"
                               HorizontalAlignment="Center" />
                    <TextBlock Text="Chats erscheinen hier, sobald Nachrichten gesendet werden"
                               FontSize="12"
                               Foreground="{DynamicResource TertiaryForegroundBrush}"
                               HorizontalAlignment="Center"
                               Margin="0,4,0,0" />
                </StackPanel>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="380" MinWidth="280" MaxWidth="550" />
            <ColumnDefinition Width="4" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>
        
        <!-- Left Panel - Chat List -->
        <Border Grid.Column="0" 
                Background="{DynamicResource BackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                
                <!-- Header -->
                <Border Grid.Row="0" 
                        Background="{DynamicResource HeaderBackgroundBrush}"
                        BorderBrush="{DynamicResource BorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="16,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <TextBlock Text="Chats"
                                       FontSize="18"
                                       FontWeight="SemiBold"
                                       Foreground="{DynamicResource ForegroundBrush}"
                                       VerticalAlignment="Center" />
                            
                            <!-- Total Unread Count -->
                            <Border Background="{DynamicResource AccentBrush}"
                                    CornerRadius="10"
                                    MinWidth="20" Height="20"
                                    Margin="8,0,0,0"
                                    VerticalAlignment="Center"
                                    Visibility="{Binding TotalUnreadCount, Converter={StaticResource CountToVisibilityConverter}}">
                                <TextBlock Text="{Binding TotalUnreadCount}"
                                           Foreground="White"
                                           FontSize="11"
                                           FontWeight="Bold"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           Margin="6,2" />
                            </Border>
                        </StackPanel>
                        
                        <!-- Refresh Button -->
                        <Button Grid.Column="1"
                                Width="32" Height="32"
                                Background="Transparent"
                                BorderThickness="0"
                                Command="{Binding RefreshCommand}"
                                ToolTip="Aktualisieren">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="Background" Value="Transparent"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                            <Path Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                                  Fill="{DynamicResource SecondaryForegroundBrush}"
                                  Width="16" Height="16"
                                  Stretch="Uniform" />
                        </Button>
                    </Grid>
                </Border>
                
                <!-- Chat List -->
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto"
                              HorizontalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding FilteredChatSummaries}">
                        <ItemsControl.Style>
                            <Style TargetType="ItemsControl">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsLoading}" Value="True">
                                        <Setter Property="ItemTemplate" Value="{StaticResource LoadingTemplate}" />
                                    </DataTrigger>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsLoading}" Value="False" />
                                            <Condition Binding="{Binding FilteredChatSummaries.Count}" Value="0" />
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="ItemTemplate" Value="{StaticResource EmptyStateTemplate}" />
                                    </MultiDataTrigger>
                                </Style.Triggers>
                                <Setter Property="ItemTemplate" Value="{StaticResource ChatListItemTemplate}" />
                            </Style>
                        </ItemsControl.Style>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
        
        <!-- Splitter -->
        <GridSplitter Grid.Column="1" 
                      Background="{DynamicResource BorderBrush}"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch" />
        
        <!-- Right Panel - Selected Chat -->
        <Border Grid.Column="2" 
                Background="{DynamicResource BackgroundBrush}">
            <Grid>
                <!-- Chat Content -->
                <ContentPresenter Content="{Binding SelectedChatViewModel}"
                                  Visibility="{Binding SelectedChatViewModel, Converter={StaticResource NullToVisibilityConverter}}">
                    <ContentPresenter.ContentTemplate>
                        <DataTemplate>
                            <views:ChatControl DataContext="{Binding}" />
                        </DataTemplate>
                    </ContentPresenter.ContentTemplate>
                </ContentPresenter>
                
                <!-- Empty State -->
                <Grid Visibility="{Binding SelectedChatViewModel, Converter={StaticResource NullToVisibilityConverter}, ConverterParameter=Invert}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Path Data="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4C22,2.89 21.1,2 20,2M6,9V7H18V9H6M6,13V11H15V13H6Z"
                              Fill="{DynamicResource TertiaryForegroundBrush}"
                              Width="64" Height="64"
                              Stretch="Uniform"
                              Margin="0,0,0,24" />
                        <TextBlock Text="Wählen Sie einen Chat aus"
                                   FontSize="18"
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource SecondaryForegroundBrush}"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Klicken Sie auf einen Chat in der Liste, um die Unterhaltung anzuzeigen"
                                   FontSize="14"
                                   Foreground="{DynamicResource TertiaryForegroundBrush}"
                                   HorizontalAlignment="Center"
                                   TextWrapping="Wrap"
                                   TextAlignment="Center"
                                   MaxWidth="300"
                                   Margin="0,8,0,0" />
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</UserControl>